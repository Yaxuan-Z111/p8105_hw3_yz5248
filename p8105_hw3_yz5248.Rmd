---
title: "p8105_hw3_yz5248"
author: "yz5248"
date: "2025-10-05"
output: github_document
---

```{r}
library(p8105.datasets)
library(readr)
library(tidyverse)  
library(scales)      
library(knitr)
library(lubridate)
library(janitor)
library(patchwork)
library(ggplot2)
library(gt)
theme_set(theme_minimal(base_size = 14))
data("instacart")
```

# Problem 1
## number of aisles and the max term
```{r}
n_aisles = 
  instacart |>
  distinct(aisle_id, aisle) |>
  nrow()
n_aisles   

aisle_counts = 
  instacart |>
  count(aisle, sort = TRUE) |>
  rename(n_orders = n)

aisle_counts |>
  slice_head(n = 20) |> 
  knitr::kable()
```
Here are totally 134 aisles.  
From the table we find that fresh vegetables is the most terms.  

### the plot showing the number of items ordered in each aisle
```{r}
aisle_counts |> 
  filter(n_orders > 10000) |> 
  mutate(aisle = fct_reorder(aisle, n_orders)) |> 
  ggplot(aes(x = aisle, y = n_orders)) +
  geom_col(fill = "blue") +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Aisles with more than 10,000 items ordered",
    x = "Aisle",
    y = "Number of items ordered"
  ) +
  theme_minimal(base_size = 13)

```

## table showing the three most popular items
```{r}
target_aisles = c("baking ingredients", "dog food care", "packaged vegetables fruits")

top3_items = 
  instacart |> 
  filter(aisle == target_aisles) |> 
  count(aisle, product_name, sort = TRUE) |> 
  group_by(aisle) |> 
  slice_head(n = 3) |> 
  ungroup()

top3_items |> 
  kable()
```

## table showing the mean hour of the day
```{r}
weekday_labels = c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")

mean_hour = 
  instacart |>
  filter(product_name == c("Pink Lady Apples", "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarise(mean_hour = mean(order_hour_of_day), .groups = "drop") |>
  mutate(weekday = factor(order_dow, levels = 0:6, labels = weekday_labels)) |>
  select(product_name, weekday, mean_hour) |>
  pivot_wider(names_from = weekday, values_from = mean_hour)

mean_hour |>
  mutate(across(where(is.numeric), ~round(., 1))) |>
  kable()
```


#Problem 2
```{r}
Zip_Codes = 
  read_csv("zillow_data/Zip Codes.csv") |>
  janitor::clean_names()|>
  view()

Zip_zori = 
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  janitor::clean_names()|>
  view()

zip_counts <- Zip_Codes |>
  group_by(zip_code) |>
  summarise(n_obs = n()) |>
  arrange(desc(n_obs)) |>
  summarise(
    full_coverage = sum(n_obs == 116),
    sparse_coverage = sum(n_obs < 10)
  )
zip_counts
```
From the table, we can find that there are 0 ZIP codes are observed 116 times and 320 ZIP codes are observed fewer than 10 times.  
The reason why some ZIP codes are observed rarely and others observed in each month may are:  
1. Different population density and housing activity among variable locations;
2. Missing data, the information of some areas is hard to collect.  

## table showing the average rental price in each borough and year 
```{r}
zip_df = 
  Zip_Codes |> 
  transmute(                      
    zip = as.character(zip_code), 
    borough = case_when(          
      str_detect(county, "New York") ~ "Manhattan",
      str_detect(county, "Kings") ~ "Brooklyn",
      str_detect(county, "Queens") ~ "Queens",
      str_detect(county, "Bronx") ~ "Bronx",
      str_detect(county, "Richmond") ~ "Staten Island",
      TRUE ~ "Other"
    )
  )

rent_df =
  Zip_zori |>
  select(region_name, starts_with("x")) |>   
  rename(zip = region_name) |>
  pivot_longer(
    cols = starts_with("x"),
    names_to = "month_raw",
    values_to = "rent"
  ) |>
  mutate(
    month = str_remove(month_raw, "^x"),
    month = str_replace_all(month, "_", "-"),
    month = ymd(month),
    zip = as.character(zip),
    rent = as.numeric(rent)
  ) |>
  select(zip, month, rent) |>
  drop_na(rent)|>
  view()

rent_with_borough = rent_df |>
  left_join(zip_df, by = "zip")

borough_year =
  rent_with_borough |>
  filter(!is.na(borough)) |>
  mutate(year = year(month)) |>
  group_by(borough, year) |>
  summarise(
    mean_rent = mean(rent, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) |>
  arrange(borough, year)

borough_year |> 
  pivot_wider(names_from = year, values_from = mean_rent) |> 
  mutate(across(-borough, ~ round(.x, 0))) |> 
  kable(
    caption = "Average Rental Price by Borough and Year (2015–2024)",
    digits = 0
  )


```
From the table, we can find that:    
From 2015 to 2024, average rental prices across New York City’s boroughs showed a steady upward trend, with a slight decline around 2020–2021 likely due to the COVID-19 pandemic.   
Manhattan consistently had the highest rents, followed by Brooklyn and Queens, while the Bronx and Staten Island remained more affordable but still experienced notable increases. After 2021, rental prices rebounded sharply—especially in Manhattan and Brooklyn—reflecting renewed housing demand. Overall, rents have risen citywide, and the price gap between Manhattan and the outer boroughs has continued to widen, highlighting growing housing affordability challenges in New York City.

## plot showing NYC Rental Prices within ZIP codes
```{r}
rent_tidy = 
  left_join(rent_df, zip_df, by = "zip") |>
  rename(Year = month) |>
  view()
```

```{r}
rent_summary =
  rent_tidy |>
  mutate(Year = year(Year)) |>    
  group_by(borough, Year) |>
  summarise(mean_rent = mean(rent, na.rm = TRUE)) |>
  arrange(borough, Year) 

rent_summary |>
  knitr::kable(
    caption = "Average Rental Price by Borough and Year (Zillow ZORI Data)",
    digits = 0
  ) 

```

```{r}
plot_trend = ggplot(rent_tidy, aes(x = Year, y = rent, group = zip)) +
  geom_line(aes(color = borough), alpha = 0.3, size = 0.6) +
  facet_wrap(~ borough, scales = "free_y") +  
  labs(
    title = "NYC Rental Prices by ZIP Code and Borough (Zillow ZORI Data)",
    x = "Year",
    y = "Rental Price (USD)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 13)
  )
plot_trend
```
The plot illustrates the rental price trends in New York City's five boroughs—Bronx, Brooklyn, Manhattan, Queens, and Staten Island—from 2016 to 2024, based on Zillow ZORI data. Manhattan consistently has the highest rental prices, peaking around $7,000, and shows a general upward trend with some fluctuations. The Bronx and Brooklyn also exhibit steady increases, with Brooklyn displaying more variability. Queens has a moderate increase, while Staten Island shows significant volatility with a sharp rise, especially noticeable from 2022. Overall, all boroughs demonstrate an upward trend in rental prices, reflecting the growing demand and cost of living in NYC. 

## About 2023
```{r}
rent_2023 = rent_tidy |>
  filter(year(Year) == 2023)


zip_mean_2023 = rent_2023 |>
  group_by(borough, zip) |>
  summarise(mean_rent = mean(rent, na.rm = TRUE), .groups = "drop")|>
  ggplot(aes(x = borough, y = mean_rent, fill = borough)) +
  geom_boxplot(alpha = 0.8, outlier.color = "red", outlier.shape = 1) +
  geom_jitter(width = 0.2, alpha = 0.4, color = "black") + 
  labs(
    title = "Distribution of Average ZIP-Code-Level Rents in 2023",
    subtitle = "Comparison across NYC boroughs (Zillow ZORI Data)",
    x = "Borough",
    y = "Average Monthly Rent (USD)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 13),
    axis.text.x = element_text(face = "bold")
  )
zip_mean_2023
```
From the boxplot, we can find that analysis of average monthly rents across New York City's boroughs for 2023 reveals significant disparities in rental prices. Manhattan leads with the highest median rent, approximately $4,000, and exhibits the greatest variability, with prices ranging up to $8,000. Brooklyn follows with a median around $3,000 and a broad spread, indicating diverse rental options. Queens has a more moderate median rent of about $2,500, while the Bronx and Staten Island both show lower medians around $2,000, with Staten Island having the narrowest spread, suggesting more uniform rental prices. This data underscores the stark differences in rental affordability and variety across NYC's boroughs, highlighting Manhattan's premium status and the more consistent, yet still diverse, rental markets in the outer boroughs.  

## Combination of the two plots
```{r}
combined_plot = plot_trend / zip_mean_2023 +
  plot_annotation(
    title = "NYC Rental Prices: Trends and 2023 Distributions",
    theme = theme(plot.title = element_text(face = "bold", size = 18))
  )

combined_plot

ggsave("results/nyc_rental_combined_plot.png",
       combined_plot,
       width = 12, height = 10, dpi = 300)
```


#Problem 3

## importing of data
```{r}
nhanes_covar = 
  read_csv("nhanes_covar.csv",skip = 4) |> 
  janitor::clean_names() |>
  view()

nhanes_accel = 
  read_csv("nhanes_accel.csv") |> 
  janitor::clean_names() |>
  view()

nhanes_full = 
  left_join(nhanes_covar, nhanes_accel, by = "seqn")|>
  view()

```

## filtering the data 
```{r}
nhanes_clean = nhanes_full |>
  filter(age >= 21) |>
  drop_na(sex, bmi, education) |> 
  mutate(
    sex = factor(sex, 
                 levels = c(1, 2),
                 labels = c("Male", "Female")),
    education = factor(education,
                       levels = c(1, 2, 3),
                       labels = c("less than high school",
                                  "High school equivalent",
                                  "More than high school")
                       ),
  )
```

## table for the number of men and women in each education category
```{r}
edu_gender_table = nhanes_clean |>
  count(education, sex) |>
  pivot_wider(
    names_from = sex, 
    values_from = n, 
    values_fill = 0
  ) |>
  mutate(Total = Male + Female) |>
  kable(
    caption = "Number of Men and Women by Education Level (NHANES Sample)",
    align = "lccc"
  )
edu_gender_table
```
This table shows the distribution of education levels among men and women in the NHANES sample. Overall, the largest group is participants with more than a high school education (115 individuals), while the smallest group is those with less than high school education (55 individuals). The numbers of men and women are fairly similar within each category, though men slightly outnumber women among those with a high school equivalent education (35 vs. 23), whereas women slightly outnumber men among the highest education group (59 vs. 56). These results suggest that, in this sample, both men and women are generally well-educated, with a small gender difference across education levels.

## plot of the age distributions for men and women in each education category
```{r}
sex_education = 
  ggplot(nhanes_clean, aes(x = education, y = age, fill = sex)) +
  geom_boxplot(width = 0.15, position = position_dodge(0.9), outlier.shape = NA, alpha = 0.5) +
  labs(
    title = "Age Distributions by Education Level and Sex",
    subtitle = "NHANES Accelerometer Sample (Age ≥ 21)",
    x = "Education Level",
    y = "Age (years)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1, face = "bold"),
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "top"
  )
sex_education
```
The boxplot provides a clear visual representation of the age distributions across different education levels and sexes within the NHANES Accelerometer Sample for individuals aged 21 and above. It reveals that the median age is approximately 50 years for all groups, indicating a predominantly middle-aged sample. The age distributions are similar for both males and females across all education levels, with no significant outliers observed. The interquartile ranges (IQRs) are also comparable, suggesting similar variability in age across different groups. This consistency in age distribution is important for ensuring the reliability and generalizability of health and lifestyle studies conducted using this sample.

## plot of total activities (y-axis) against age (x-axis)
```{r}
total_activity = nhanes_clean |>
  mutate(total_activity = rowSums(select(cur_data(), starts_with("min")), na.rm = TRUE)) |>
  select(seqn, sex, age, education, total_activity) |>
  view()

activity_plot = 
  ggplot(total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~education) +
  labs(
    x = "Age",
    y = "Total Activity (sum of minute-level counts)",
    title = "Total Daily Activity vs Age by Sex and Education Level"
  ) +
  theme_minimal()
activity_plot
```
The plot depicting total daily activity against age, segmented by sex and education level, reveals several key insights. It shows a general decline in activity levels with increasing age across all education levels. Males tend to exhibit slightly higher activity levels than females, particularly in the groups with less than high school and high school equivalent education. Notably, individuals with more than a high school education display higher activity levels across most age groups compared to those with lower education levels. The high school equivalent group shows a bimodal trend with two distinct peaks, suggesting two periods of increased activity, likely around middle age. There is also considerable variability in activity levels within each age and education group, as indicated by the spread of data points around the trend lines. The presence of outliers, especially in older age groups, indicates that some individuals maintain high activity levels despite their age. Overall, this data underscores the influence of education and sex on daily physical activity, highlighting the importance of targeted public health initiatives to promote physical activity among different demographic groups.

## on activity over the course of the day
```{r}
nhanes_daylong = nhanes_clean |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "activity"
  ) |>
  mutate(
    minute = as.numeric(gsub("min", "", minute)),   
    hour = minute / 60                             
  )
nhanes_daylong

daylong_plot = 
  ggplot(nhanes_daylong, aes(x = hour, y = activity, color = sex)) +
  geom_smooth(se = FALSE, span = 0.2) +   
  facet_wrap(~education) +
  labs(
    title = "24-hour Activity Patterns by Education Level and Sex",
    x = "Hour of Day",
    y = "Activity Count (Accelerometer)",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
daylong_plot
```
The graph illustrates the 24-hour activity patterns, measured by accelerometer counts, across different education levels and sexes. All groups exhibit a bimodal distribution of activity, with two main peaks typically around morning and evening hours, suggesting two periods of increased activity. Males generally show slightly higher activity counts than females, especially in the group with less than a high school education. As education level increases, the activity levels between males and females become more similar, and the overall activity levels appear to be slightly higher, particularly in the group with more than a high school education. The smoother trends observed in the "more than high school" group suggest a more regular and structured daily routine compared to the other groups. This data underscores the influence of education and sex on daily physical activity patterns, which could be valuable for designing targeted health and lifestyle interventions.
