---
title: "p8105_hw3_yz5248"
author: "yz5248"
date: "2025-10-05"
output: github_document
---

```{r}
library(p8105.datasets)
library(readr)
library(tidyverse)  
library(scales)      
library(knitr)
library(lubridate)
library(janitor)
library(patchwork)
library(ggplot2)
library(gt)
theme_set(theme_minimal(base_size = 14))
data("instacart")
```

# Problem 1
## number of aisles and the max term
```{r}
n_aisles = 
  instacart |>
  distinct(aisle_id, aisle) |>
  nrow()
n_aisles   

aisle_counts = 
  instacart |>
  count(aisle, sort = TRUE) |>
  rename(n_orders = n)

aisle_counts |>
  slice_head(n = 20) |> 
  knitr::kable()
```
Here are totally 134 aisles.  
From the table we find that fresh vegetables is the most terms.  

### the plot showing the number of items ordered in each aisle
```{r}
aisle_counts |> 
  filter(n_orders > 10000) |> 
  mutate(aisle = fct_reorder(aisle, n_orders)) |> 
  ggplot(aes(x = aisle, y = n_orders)) +
  geom_col(fill = "blue") +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Aisles with more than 10,000 items ordered",
    x = "Aisle",
    y = "Number of items ordered"
  ) +
  theme_minimal(base_size = 13)

```

## table showing the three most popular items
```{r}
target_aisles = c("baking ingredients", "dog food care", "packaged vegetables fruits")

top3_items = 
  instacart |> 
  filter(aisle == target_aisles) |> 
  count(aisle, product_name, sort = TRUE) |> 
  group_by(aisle) |> 
  slice_head(n = 3) |> 
  ungroup()

top3_items |> 
  kable()
```

## table showing the mean hour of the day
```{r}
weekday_labels = c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")

mean_hour = 
  instacart |>
  filter(product_name == c("Pink Lady Apples", "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarise(mean_hour = mean(order_hour_of_day), .groups = "drop") |>
  mutate(weekday = factor(order_dow, levels = 0:6, labels = weekday_labels)) |>
  select(product_name, weekday, mean_hour) |>
  pivot_wider(names_from = weekday, values_from = mean_hour)

mean_hour |>
  mutate(across(where(is.numeric), ~round(., 1))) |>
  kable()
```


#Problem 2
```{r}
Zip_Codes = 
  read_csv("zillow_data/Zip Codes.csv") |>
  janitor::clean_names()|>
  view()

Zip_zori = 
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  janitor::clean_names()|>
  view()

zip_counts <- Zip_Codes |>
  group_by(zip_code) |>
  summarise(n_obs = n()) |>
  arrange(desc(n_obs)) |>
  summarise(
    full_coverage = sum(n_obs == 116),
    sparse_coverage = sum(n_obs < 10)
  )
zip_counts
```
From the table, we can find that there are 0 ZIP codes are observed 116 times and 320 ZIP codes are observed fewer than 10 times.  
The reason why some ZIP codes are observed rarely and others observed in each month may are:  
1. Different population density and housing activity among variable locations;
2. Missing data, the information of some areas is hard to collect.  

## table showing the average rental price in each borough and year 
```{r}
zip_df = 
  Zip_Codes |> 
  transmute(                      
    zip = as.character(zip_code), 
    borough = case_when(          
      str_detect(county, "New York") ~ "Manhattan",
      str_detect(county, "Kings") ~ "Brooklyn",
      str_detect(county, "Queens") ~ "Queens",
      str_detect(county, "Bronx") ~ "Bronx",
      str_detect(county, "Richmond") ~ "Staten Island",
      TRUE ~ "Other"
    )
  )

rent_df =
  Zip_zori |>
  select(region_name, starts_with("x")) |>   
  rename(zip = region_name) |>
  pivot_longer(
    cols = starts_with("x"),
    names_to = "month_raw",
    values_to = "rent"
  ) |>
  mutate(
    month = str_remove(month_raw, "^x"),
    month = str_replace_all(month, "_", "-"),
    month = ymd(month),
    zip = as.character(zip),
    rent = as.numeric(rent)
  ) |>
  select(zip, month, rent) |>
  drop_na(rent)|>
  view()

rent_with_borough = rent_df |>
  left_join(zip_df, by = "zip")

borough_year =
  rent_with_borough |>
  filter(!is.na(borough)) |>
  mutate(year = year(month)) |>
  group_by(borough, year) |>
  summarise(
    mean_rent = mean(rent, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) |>
  arrange(borough, year)

borough_year_table =
  borough_year |>
  mutate(mean_fmt = paste0("$", comma(round(mean_rent, 0)), " (n=", n, ")")) |>
  select(borough, year, mean_fmt) |>
  pivot_wider(
    names_from = year,
    values_from = mean_fmt
  ) |>
  arrange(borough) |>
  gt() |>   
  tab_header(
    title = "Average Rental Price by Borough and Year",
    subtitle = "Monthly average rental prices (2015–2024)"
  ) |>
  tab_options(
    table.font.names = "Helvetica",
    table.font.size = 12,
    table.align = "center",
    data_row.padding = px(5),
    heading.align = "center"
  ) |>
  cols_label(
    borough = "Borough"
  )

borough_year_table


```
From the table, we can find that:  



## plot showing NYC Rental Prices within ZIP codes
```{r}
rent_tidy = 
  left_join(rent_df, zip_df, by = "zip") |>
  rename(Year = month) |>
  view()
```

```{r}
rent_summary =
  rent_tidy |>
  mutate(Year = year(Year)) |>    
  group_by(borough, Year) |>
  summarise(mean_rent = mean(rent, na.rm = TRUE)) |>
  arrange(borough, Year) 

rent_summary |>
  knitr::kable(
    caption = "Average Rental Price by Borough and Year (Zillow ZORI Data)",
    digits = 0
  ) 

```

```{r}
plot_trend = ggplot(rent_tidy, aes(x = Year, y = rent, group = zip)) +
  geom_line(aes(color = borough), alpha = 0.3, size = 0.6) +
  facet_wrap(~ borough, scales = "free_y") +  
  labs(
    title = "NYC Rental Prices by ZIP Code and Borough (Zillow ZORI Data)",
    x = "Year",
    y = "Rental Price (USD)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 13)
  )
plot_trend
```

## About 2023
```{r}
rent_2023 = rent_tidy |>
  filter(year(Year) == 2023)


zip_mean_2023 = rent_2023 |>
  group_by(borough, zip) |>
  summarise(mean_rent = mean(rent, na.rm = TRUE), .groups = "drop")|>
  ggplot(aes(x = borough, y = mean_rent, fill = borough)) +
  geom_boxplot(alpha = 0.8, outlier.color = "red", outlier.shape = 1) +
  geom_jitter(width = 0.2, alpha = 0.4, color = "black") + 
  labs(
    title = "Distribution of Average ZIP-Code-Level Rents in 2023",
    subtitle = "Comparison across NYC boroughs (Zillow ZORI Data)",
    x = "Borough",
    y = "Average Monthly Rent (USD)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 13),
    axis.text.x = element_text(face = "bold")
  )
zip_mean_2023
```

## Combination of the two plots
```{r}
combined_plot = plot_trend / zip_mean_2023 +
  plot_annotation(
    title = "NYC Rental Prices: Trends and 2023 Distributions",
    theme = theme(plot.title = element_text(face = "bold", size = 18))
  )

combined_plot

ggsave("results/nyc_rental_combined_plot.png",
       combined_plot,
       width = 12, height = 10, dpi = 300)
```


#Problem 3
```{r}
nhanes_covar = 
  read_csv("nhanes_covar.csv",skip = 4) |> 
  janitor::clean_names() |>
  view()

nhanes_accel = 
  read_csv("nhanes_accel.csv") |> 
  janitor::clean_names() |>
  view()

nhanes_full = 
  left_join(nhanes_covar, nhanes_accel, by = "seqn")|>
  view()

```

```{r}
nhanes_clean = nhanes_full |>
  filter(age >= 21) |>
  drop_na(sex, bmi, education) |> 
  mutate(
    sex = factor(sex, 
                 levels = c(1, 2),
                 labels = c("Male", "Female")),
    education = factor(education,
                       levels = c(1, 2, 3),
                       labels = c("less than high school",
                                  "High school equivalent",
                                  "More than high school")
                       ),
  )
```

```{r}
edu_gender_table = nhanes_clean |>
  count(education, sex) |>
  pivot_wider(
    names_from = sex, 
    values_from = n, 
    values_fill = 0
  ) |>
  mutate(Total = Male + Female) |>
  kable(
    caption = "Number of Men and Women by Education Level (NHANES Sample)",
    align = "lccc"
  )
edu_gender_table
```

```{r}
sex_education = 
  ggplot(nhanes_clean, aes(x = education, y = age, fill = sex)) +
  geom_boxplot(width = 0.15, position = position_dodge(0.9), outlier.shape = NA, alpha = 0.5) +
  labs(
    title = "Age Distributions by Education Level and Sex",
    subtitle = "NHANES Accelerometer Sample (Age ≥ 21)",
    x = "Education Level",
    y = "Age (years)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1, face = "bold"),
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "top"
  )
sex_education
```

```{r}
total_activity = nhanes_clean |>
  mutate(total_activity = rowSums(select(cur_data(), starts_with("min")), na.rm = TRUE)) |>
  select(seqn, sex, age, education, total_activity) |>
  view()

activity_plot = 
  ggplot(total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~education) +
  labs(
    x = "Age",
    y = "Total Activity (sum of minute-level counts)",
    title = "Total Daily Activity vs Age by Sex and Education Level"
  ) +
  theme_minimal()
activity_plot
```

```{r}
nhanes_daylong = nhanes_clean |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "activity"
  ) |>
  mutate(
    minute = as.numeric(gsub("min", "", minute)),   
    hour = minute / 60                             
  )
nhanes_daylong

daylong_plot = 
  ggplot(nhanes_daylong, aes(x = hour, y = activity, color = sex)) +
  geom_smooth(se = FALSE, span = 0.2) +   
  facet_wrap(~education) +
  labs(
    title = "24-hour Activity Patterns by Education Level and Sex",
    x = "Hour of Day",
    y = "Activity Count (Accelerometer)",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
daylong_plot
```

